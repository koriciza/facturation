{% extends "base.html" %}
{% block content %}

<!-- Store products as JSON -->
<script id="products-data" type="application/json">
    {{ produits_serialized|tojson }}
</script>

<div class="form-container">
    <div class="card">
        <div class="card-header">
            <h2>
                {% if facture %}
                    {% if facture.type_document == 'avoir' %}
                        ‚úèÔ∏è Modifier l'avoir n¬∞{{ facture.numero }}
                    {% else %}
                        ‚úèÔ∏è Modifier la facture n¬∞{{ facture.numero }}
                    {% endif %}
                {% else %}
                    {% if type_document == 'avoir' %}
                        ‚û°Ô∏è Nouvel Avoir (Note de cr√©dit)
                    {% else %}
                        ‚ûï Nouvelle Facture
                    {% endif %}
                {% endif %}
            </h2>
            <div style="margin-top: 10px;">
                {% if not facture %}
                <div style="display: flex; gap: 10px;">
                    <a href="{{ url_for('facture_new', type='facture') }}" class="btn {% if type_document == 'facture' %}btn-primary{% else %}btn-secondary{% endif %}">
                        üìÑ Facture normale
                    </a>
                    <a href="{{ url_for('facture_new', type='avoir') }}" class="btn {% if type_document == 'avoir' %}btn-primary{% else %}btn-secondary{% endif %}">
                        ‚Ü©Ô∏è Avoir (Note de cr√©dit)
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <form method="post" id="factureForm">
            <input type="hidden" name="type_document" value="{{ type_document or (facture.type_document if facture else 'facture') }}">
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Client -->
               

                          <div class="form-group">
                    <label for="client_id">üë§ Client <span style="color: #e53e3e;">*</span></label>
                    <select id="client_id" name="client_id" required {% if facture_originale %}disabled{% endif %}>
                        <option value="">S√©lectionnez un client</option>
                        {% for client in clients %}
                        <option value="{{ client.id }}" 
                                {% if facture_originale and facture_originale.client_id == client.id %}selected{% endif %}
                                {% if facture and facture.client_id == client.id %}selected{% endif %}>
                            {{ client.nom }} {{ client.prenom }} {% if client.telephone %}- üìû {{ client.telephone }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    {% if facture_originale %}
                    <input type="hidden" name="client_id" value="{{ facture_originale.client_id }}">
                    {% endif %}
                </div>


                <!-- Mode de paiement am√©lior√© -->
                <div class="form-group">
                    <label for="paiement">üí∞ Mode de paiement <span style="color: #e53e3e;">*</span></label>
                    <select id="paiement" name="paiement" required onchange="toggleDeviseField()">
                        <option value="">S√©lectionnez un mode</option>
                        <option value="esp√®ces" {% if facture and facture.paiement == 'esp√®ces' %}selected{% endif %}>üíµ Esp√®ces</option>
                        <option value="carte" {% if facture and facture.paiement == 'carte' %}selected{% endif %}>üí≥ Carte bancaire</option>
                        <option value="cr√©dit" {% if facture and facture.paiement == 'cr√©dit' %}selected{% endif %}>üìù Cr√©dit</option>
                        <option value="banque" {% if facture and facture.paiement == 'banque' %}selected{% endif %}>üè¶ Virement bancaire</option>
                        <option value="mobile" {% if facture and facture.paiement == 'mobile' %}selected{% endif %}>üì± Mobile money</option>
                        <option value="autre" {% if facture and facture.paiement == 'autre' %}selected{% endif %}>üîÑ Autre</option>
                    </select>
                </div>

                <!-- Champ devise (cach√© par d√©faut) -->
                <div id="devise-container" class="form-group" style="display: none;">
                    <label for="devise">üí± Devise</label>
                    <select id="devise" name="devise">
                        <option value="">Choisissez une devise</option>
                        <option value="FBU" {% if facture and facture.devise == 'FBU' %}selected{% endif %}>üáßüáÆ FBU (Franc burundais)</option>
                        <option value="EUR" {% if facture and facture.devise == 'EUR' %}selected{% endif %}>üá™üá∫ Euro</option>
                        <option value="USD" {% if facture and facture.devise == 'USD' %}selected{% endif %}>üá∫üá∏ Dollar US</option>
                    </select>
                </div>

                <!-- √âtat -->
                <div class="form-group">
                    <label for="etat">üìä √âtat</label>
                    <select id="etat" name="etat">
                        <option value="En attente" {% if facture and facture.etat == 'En attente' %}selected{% endif %}>‚è≥ En attente</option>
                        <option value="Pay√©e" {% if facture and facture.etat == 'Pay√©e' %}selected{% endif %}>‚úÖ Pay√©e</option>
                        <option value="Annul√©e" {% if facture and facture.etat == 'Annul√©e' %}selected{% endif %}>‚ùå Annul√©e</option>
                    </select>
                </div>
            </div>

            <!-- Facture d'origine pour les avoirs -->
                       <!-- Facture d'origine pour les avoirs -->
            {% if type_document == 'avoir' or (facture and facture.type_document == 'avoir') %}
            <div class="form-group" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label for="facture_originale_id">üìé Facture d'origine</label>
                <select id="facture_originale_id" name="facture_originale_id" 
                        style="width: 100%; padding: 8px; border: 1px solid #ffe69b; border-radius: 4px;"
                        {% if facture_originale %}disabled{% endif %}>
                    <option value="">S√©lectionnez une facture √† cr√©diter</option>
                    {% for facture_orig in factures %}
                        <option value="{{ facture_orig.id }}" 
                                {% if facture_originale and facture_orig.id == facture_originale.id %}selected{% endif %}
                                {% if facture and facture.facture_originale_id == facture_orig.id %}selected{% endif %}>
                            {{ facture_orig.numero or facture_orig.id }} - {{ facture_orig.client.nom }} {{ facture_orig.client.prenom }} - 
                            {{ facture_orig.date_creation.strftime('%d/%m/%Y') }} - {{ "{:,.0f}".format(facture_orig.total).replace(',', ' ') }} FBU
                        </option>
                    {% endfor %}
                </select>
                {% if facture_originale %}
                <input type="hidden" name="facture_originale_id" value="{{ facture_originale.id }}">
                <p style="margin-top: 10px; color: #856404;">
                    <strong>Produits disponibles :</strong> Cette facture contient {{ facture_originale.lignes|length }} produit(s)
                </p>
                {% endif %}
               <!-- <small style="color: #856404;">S√©lectionnez la facture que vous souhaitez cr√©diter</small>-->
            </div>
            {% endif %}

           
                      <h3 style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
                <span>
                    {% if type_document == 'avoir' or (facture and facture.type_document == 'avoir') %}
                    ‚Ü©Ô∏è Produits √† cr√©diter
                    {% else %}
                    üì¶ Produits factur√©s
                    {% endif %}
                </span>
                <button type="button" id="ajouter_produit" class="btn btn-success btn-sm">‚ûï Ajouter un produit</button>
            </h3>
        
            <div id="produits-container" style="margin-bottom: 20px;">
    {% if facture_originale %}
        <!-- Pr√©-remplir avec les produits de la facture d'origine -->
        {% for ligne in facture_originale.lignes %}
        <div class="product-row">
            <div class="product-fields">
                <div class="form-group">
                    <label>Produit :</label>
                    <select name="produit_id[]" required onchange="updateProductInfo(this)">
                        <option value="">Choisir</option>
                        {% for produit in produits %}
                        <option value="{{ produit.id }}" 
                                data-prix="{{ produit.pv_ttc }}"
                                data-tva="{{ produit.tva }}"
                                {% if ligne.produit_id == produit.id %}selected{% endif %}>
                            {{ produit.nom }} ({{ produit.code or 'N/A' }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantit√© :</label>
                    <input type="number" name="quantite[]" value="{{ ligne.quantite }}" min="0.01" step="0.01" required onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label>PU HT :</label>
                    <input type="number" step="0.01" name="prix_unitaire[]" value="{{ ligne.prix_unitaire }}" required onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label>TVA % :</label>
                    <input type="number" step="0.1" name="tva[]" class="tva-input" value="{{ ligne.tva or 0 }}" required onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label>Total TTC :</label>
                    <div class="ligne-total-ttc">{{ "%.2f"|format(ligne.quantite * ligne.prix_unitaire * (1 + (ligne.tva or 0)/100)) }} FBU</div>
                </div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.product-row').remove(); calculerTotaux();">üóëÔ∏è Supprimer</button>
        </div>
        {% endfor %}
    {% elif facture %}
        <!-- Afficher les produits de la facture existante (pour √©dition) -->
        {% for ligne in facture.lignes %}
        <div class="product-row">
            <div class="product-fields">
                <div class="form-group">
                    <label>Produit :</label>
                    <select name="produit_id[]" required onchange="updateProductInfo(this)">
                        <option value="">Choisir</option>
                        {% for produit in produits %}
                        <option value="{{ produit.id }}" 
                                data-prix="{{ produit.pv_ttc }}"
                                data-tva="{{ produit.tva }}"
                                {% if ligne.produit_id == produit.id %}selected{% endif %}>
                            {{ produit.nom }} ({{ produit.code or 'N/A' }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantit√© :</label>
                    <input type="number" name="quantite[]" value="{{ ligne.quantite }}" min="0.01" step="0.01" required onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label>PU HT :</label>
                    <input type="number" step="0.01" name="prix_unitaire[]" value="{{ ligne.prix_unitaire }}" required onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label>TVA % :</label>
                    <input type="number" step="0.1" name="tva[]" class="tva-input" value="{{ ligne.tva or 0 }}" required onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label>Total TTC :</label>
                    <div class="ligne-total-ttc">{{ "%.2f"|format(ligne.quantite * ligne.prix_unitaire * (1 + (ligne.tva or 0)/100)) }} FBU</div>
                </div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.product-row').remove(); calculerTotaux();">üóëÔ∏è Supprimer</button>
        </div>
        {% endfor %}
    {% endif %}
</div>

            <!-- R√©sum√© des totaux -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                    <div>
                        <h4 style="margin: 0; color: #4a5568;">Total HT</h4>
                        <p style="font-size: 19px; font-weight: bold; color: #2d3748; margin: 10px 0;">
                            <span id="total_ht">0.00</span> FBU
                        </p>
                    </div>
                    <div>
                        <h4 style="margin: 0; color: #4a5568;">TVA</h4>
                        <p style="font-size: 19px; font-weight: bold; color: #2d3748; margin: 10px 0;">
                            <span id="total_tva">0.00</span> FBU
                        </p>
                    </div>
                    <div>
                        <h4 style="margin: 0; color: #4a5568;">Total TTC</h4>
                        <p style="font-size: 24px; font-weight: bold; color: #48bb78; margin: 10px 0;">
                            <span id="total_ttc">0.00</span> FBU
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Notes -->
            <div class="form-group">
                <label for="notes">üìù Notes</label>
                <textarea id="notes" name="notes" rows="3" placeholder="Informations compl√©mentaires...">{{ facture.notes if facture else '' }}</textarea>
            </div>
            
            <!-- Boutons d'action -->
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                <a href="{{ url_for('factures_list') }}" class="btn btn-secondary">‚Ü©Ô∏è Annuler</a>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    {% if facture %}üíæ Mettre √† jour{% else %}üíæ Cr√©er{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .product-row {
        background: #f8f9ff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #48bb78;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .product-row:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .product-fields {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    @media screen and (max-width: 768px) {
        .product-fields {
            grid-template-columns: 1fr;
        }
    }
    
    .btn-sm {
        padding: 8px 16px;
        font-size: 14px;
    }
    
    .ligne-total-ttc {
        background: #e6fffa;
        padding: 8px;
        border-radius: 4px;
        text-align: right;
        font-weight: bold;
        color: #2c7a7b;
    }
    
    /* Style pour les avoirs */
    {% if type_document == 'avoir' %}
    .product-row {
        border-left-color: #ed8936;
        background: #fffaf0;
    }
    .ligne-total-ttc {
        background: #feebc8;
        color: #c05621;
    }
    {% endif %}
    
    /* Animation pour le bouton d'ajout */
    #ajouter_produit {
        transition: all 0.3s ease;
    }
    
    #ajouter_produit:hover {
        transform: scale(1.05);
    }
    
    /* Badge pour stock */
    .stock-badge {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 10px;
        background: #e2e8f0;
        color: #4a5568;
        margin-left: 5px;
    }
</style>

<script>
    let produits = JSON.parse(document.getElementById('products-data').textContent);
    let typeDocument = '{{ type_document or (facture.type_document if facture else "facture") }}';

    // Fonction pour afficher/masquer le champ devise
    function toggleDeviseField() {
        const paiementSelect = document.getElementById('paiement');
        const deviseContainer = document.getElementById('devise-container');
        const deviseSelect = document.getElementById('devise');
        
        if (paiementSelect.value === 'esp√®ces') {
            deviseContainer.style.display = 'block';
            deviseSelect.required = true;
        } else {
            deviseContainer.style.display = 'none';
            deviseSelect.required = false;
            deviseSelect.value = '';
        }
    }

    function ajouterProduit() {
        let container = document.getElementById('produits-container');
        let index = container.children.length;
        
        let productRow = document.createElement('div');
        productRow.className = 'product-row';
        productRow.dataset.index = index;
        
        let html = `
            <div class="product-fields">
                <div class="form-group">
                    <label>Produit :</label>
                    <select name="produit_id[]" required onchange="updateProductInfo(this)">
                        <option value="">Choisir</option>
                        ${produits.map(p => `<option value="${p.id}" data-prix="${p.pv_ttc}" data-tva="${p.tva}">${p.nom} (${p.code || 'N/A'}) - Stock: ${p.stock_actuel || 0}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantit√© :</label>
                    <input type="number" name="quantite[]" min="0.01" step="0.01" value="1" required onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label>Prix unitaire HT :</label>
                    <input type="number" step="0.01" name="prix_unitaire[]" value="0" required onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label>TVA % :</label>
                    <input type="number" step="0.1" name="tva[]" class="tva-input" value="20" required onchange="calculerTotaux()">
                </div>
                <div class="form-group">
                    <label>Total TTC :</label>
                    <div class="ligne-total-ttc">0.00 FBU</div>
                </div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.product-row').remove(); calculerTotaux();">üóëÔ∏è Supprimer</button>
        `;
        
        productRow.innerHTML = html;
        container.appendChild(productRow);
        
        // Add event listeners to inputs
        let inputs = productRow.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                if (this.tagName === 'SELECT') {
                    updateProductInfo(this);
                }
                calculerTotaux();
            });
        });
        
        // Animation
        productRow.style.opacity = '0';
        productRow.style.transform = 'translateY(20px)';
        setTimeout(() => {
            productRow.style.opacity = '1';
            productRow.style.transform = 'translateY(0)';
        }, 10);
    }

    function updateProductInfo(select) {
        let row = select.closest('.product-row');
        let prixInput = row.querySelector('input[name="prix_unitaire[]"]');
        let tvaInput = row.querySelector('.tva-input');
        let selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption.value) {
            let prix = selectedOption.dataset.prix;
            let tva = selectedOption.dataset.tva;
            
            if (prix) prixInput.value = prix;
            if (tva) tvaInput.value = tva;
        }
        calculerTotaux();
    }

    function calculerTotaux() {
        let totalHT = 0;
        let totalTVA = 0;
        let totalTTC = 0;
        
        document.querySelectorAll('.product-row').forEach(row => {
            let quantite = parseFloat(row.querySelector('[name="quantite[]"]').value) || 0;
            let prixHT = parseFloat(row.querySelector('[name="prix_unitaire[]"]').value) || 0;
            let tva = parseFloat(row.querySelector('[name="tva[]"]').value) || 0;
            
            let ligneHT = quantite * prixHT;
            let ligneTVA = ligneHT * (tva/100);
            let ligneTTC = ligneHT + ligneTVA;
            
            totalHT += ligneHT;
            totalTVA += ligneTVA;
            totalTTC += ligneTTC;
            
            row.querySelector('.ligne-total-ttc').textContent = ligneTTC.toFixed(2) + ' FBU';
        });
        
        document.getElementById('total_ht').textContent = totalHT.toFixed(2);
        document.getElementById('total_tva').textContent = totalTVA.toFixed(2);
        document.getElementById('total_ttc').textContent = totalTTC.toFixed(2);
    }

    // Validation avant soumission
    document.getElementById('factureForm').addEventListener('submit', function(e) {
        const productRows = document.querySelectorAll('.product-row');
        if (productRows.length === 0) {
            e.preventDefault();
            alert('Veuillez ajouter au moins un produit √† la facture.');
            return;
        }
        
        // V√©rifier que toutes les lignes ont un produit s√©lectionn√©
        let valid = true;
        productRows.forEach(row => {
            const select = row.querySelector('select[name="produit_id[]"]');
            if (!select.value) {
                valid = false;
                select.style.borderColor = '#e53e3e';
            }
        });
        
        if (!valid) {
            e.preventDefault();
            alert('Veuillez s√©lectionner un produit pour chaque ligne.');
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser le champ devise
        toggleDeviseField();
        
        // Ajouter une ligne si aucune n'existe
        if (document.querySelectorAll('.product-row').length === 0) {
            ajouterProduit();
        }
        
        document.getElementById('ajouter_produit').addEventListener('click', ajouterProduit);
        
        calculerTotaux();
    });
</script>
{% endblock %}