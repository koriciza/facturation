{% extends "base.html" %}
{% block content %}

<!-- Store products as JSON -->
<script id="products-data" type="application/json">
    {{ produits|tojson }}
</script>

<div class="form-container">
    <div class="card">
        <div class="card-header">
            <h2>{% if facture %}‚úèÔ∏è Modifier{% else %}‚ûï Nouvelle{% endif %} Facture</h2>
        </div>
        
        <form method="post">
            <div class="form-group">
                <label for="client_id">Client :</label>
                <select id="client_id" name="client_id" required>
                    <option value="">S√©lectionnez un client</option>
                    {% for client in clients %}
                    <option value="{{ client.id }}" {% if facture and facture.client_id == client.id %}selected{% endif %}>
                        {{ client.nom }} {{ client.prenom }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="paiement">Mode de paiement :</label>
                <input type="text" id="paiement" name="paiement" value="{{ facture.paiement if facture else '' }}" placeholder="Ex: Carte, Esp√®ces, Virement">
            </div>

            <div class="form-group">
                <label for="etat">√âtat :</label>
                <select id="etat" name="etat">
                    <option value="En attente" {% if facture and facture.etat == 'En attente' %}selected{% endif %}>En attente</option>
                    <option value="Pay√©e" {% if facture and facture.etat == 'Pay√©e' %}selected{% endif %}>Pay√©e</option>
                    <option value="Annul√©e" {% if facture and facture.etat == 'Annul√©e' %}selected{% endif %}>Annul√©e</option>
                </select>
            </div>

            <h3>üì¶ Produits</h3>
            <div id="produits-container">
                {% if facture %}
                    {% for ligne in facture.lignes %}
                    <div class="product-row">
                        <div class="product-fields">
                            <div class="form-group">
                                <label>Produit :</label>
                                <!-- In the product selection part, update the select options -->
                                <select name="produit_id[]" required>
                                    <option value="">Choisir</option>
                                    {% for produit in produits %}
                                    <option value="{{ produit.id }}" data-prix="{{ produit.pv_ttc }}">
                                        {{ produit.nom }} ({{ produit.code or 'N/A' }}) - {{ produit.pv_ttc }} ‚Ç¨
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantit√© :</label>
                                <input type="number" name="quantite[]" value="{{ ligne.quantite }}" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Prix unitaire :</label>
                                <input type="number" step="0.01" name="prix_unitaire[]" value="{{ ligne.prix_unitaire }}" required>
                            </div>
                            <div class="form-group">
                                <label>Total :</label>
                                <div class="ligne-total">{{ "%.2f"|format(ligne.total) }} ‚Ç¨</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm supprimer-ligne">üóëÔ∏è Supprimer</button>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            
            <div class="flex justify-between align-center mt-20">
                <button type="button" id="ajouter_produit" class="btn btn-success">‚ûï Ajouter un produit</button>
                <h3>Total : <span id="total_facture">0.00</span> ‚Ç¨</h3>
            </div>
            
            <div class="flex gap-10 mt-20">
                <button type="submit" class="btn btn-primary">üíæ Enregistrer</button>
                <a href="{{ url_for('factures_list') }}" class="btn btn-warning">‚Ü©Ô∏è Annuler</a>
            </div>
        </form>
    </div>
</div>

<script>
    function ajouterProduit() {
        var container = document.getElementById('produits-container');
        var products = JSON.parse(document.getElementById('products-data').textContent);
        
        var productRow = document.createElement('div');
        productRow.className = 'product-row';
        
        var fieldsDiv = document.createElement('div');
        fieldsDiv.className = 'product-fields';
        
        // Product select
        var selectGroup = document.createElement('div');
        selectGroup.className = 'form-group';
        var selectLabel = document.createElement('label');
        selectLabel.textContent = 'Produit :';
        var select = document.createElement('select');
        select.name = 'produit_id[]';
        select.required = true;
        
        var option0 = document.createElement('option');
        option0.value = '';
        option0.textContent = 'Choisir';
        select.appendChild(option0);
        
        products.forEach(function(produit) {
            var option = document.createElement('option');
            option.value = produit.id;
            option.textContent = produit.nom;
            select.appendChild(option);
        });
        
        selectGroup.appendChild(selectLabel);
        selectGroup.appendChild(select);
        fieldsDiv.appendChild(selectGroup);
        
        // Quantity input
        var quantiteGroup = document.createElement('div');
        quantiteGroup.className = 'form-group';
        var quantiteLabel = document.createElement('label');
        quantiteLabel.textContent = 'Quantit√© :';
        var quantite = document.createElement('input');
        quantite.type = 'number';
        quantite.name = 'quantite[]';
        quantite.min = 1;
        quantite.value = 1;
        quantite.required = true;
        
        quantiteGroup.appendChild(quantiteLabel);
        quantiteGroup.appendChild(quantite);
        fieldsDiv.appendChild(quantiteGroup);
        
        // Price input
        var prixGroup = document.createElement('div');
        prixGroup.className = 'form-group';
        var prixLabel = document.createElement('label');
        prixLabel.textContent = 'Prix unitaire :';
        var prix = document.createElement('input');
        prix.type = 'number';
        prix.name = 'prix_unitaire[]';
        prix.step = '0.01';
        prix.value = 0;
        prix.required = true;
        
        prixGroup.appendChild(prixLabel);
        prixGroup.appendChild(prix);
        fieldsDiv.appendChild(prixGroup);
        
        // Total display
        var totalGroup = document.createElement('div');
        totalGroup.className = 'form-group';
        var totalLabel = document.createElement('label');
        totalLabel.textContent = 'Total :';
        var totalSpan = document.createElement('div');
        totalSpan.className = 'ligne-total';
        totalSpan.textContent = '0.00 ‚Ç¨';
        
        totalGroup.appendChild(totalLabel);
        totalGroup.appendChild(totalSpan);
        fieldsDiv.appendChild(totalGroup);
        
        productRow.appendChild(fieldsDiv);
        
        // Delete button
        var deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-danger btn-sm supprimer-ligne';
        deleteBtn.textContent = 'üóëÔ∏è Supprimer';
        deleteBtn.addEventListener('click', function() {
            productRow.remove();
            calculerTotal();
        });
        productRow.appendChild(deleteBtn);
        
        container.appendChild(productRow);
        
        // Update total on input
        function updateLineTotal() {
            var q = parseFloat(quantite.value) || 0;
            var p = parseFloat(prix.value) || 0;
            totalSpan.textContent = (q * p).toFixed(2) + ' ‚Ç¨';
            calculerTotal();
        }
        
        quantite.addEventListener('input', updateLineTotal);
        prix.addEventListener('input', updateLineTotal);
    }

    function calculerTotal() {
        var total = 0;
        var rows = document.querySelectorAll('.product-row');
        rows.forEach(row => {
            var q = parseFloat(row.querySelector('input[name="quantite[]"]').value) || 0;
            var p = parseFloat(row.querySelector('input[name="prix_unitaire[]"]').value) || 0;
            total += q * p;
        });
        document.getElementById('total_facture').textContent = total.toFixed(2);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (document.querySelectorAll('.product-row').length === 0) {
            ajouterProduit();
        }
        
        document.getElementById('ajouter_produit').addEventListener('click', ajouterProduit);
        
        document.querySelectorAll('.supprimer-ligne').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.product-row').remove();
                calculerTotal();
            });
        });
        
        calculerTotal();
    });


    select.addEventListener('change', function() {
    var selectedOption = this.options[this.selectedIndex];
    if (selectedOption.value) {
        // If you have data-prix attribute, auto-fill the price
        var prix = selectedOption.getAttribute('data-prix');
        if (prix) {
            prixInput.value = prix;
            updateLineTotal();
        }
    }
});

</script>
{% endblock %}