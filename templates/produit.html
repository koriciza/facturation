{% extends "base.html" %}
{% block content %}
<div class="card">
    <div class="card-header">
        <h2>üì¶ {{ produit.nom }}</h2>
        <div>
            <a href="{{ url_for('produit_edit', id=produit.id) }}" class="btn btn-warning">‚úèÔ∏è Modifier</a>
            <a href="{{ url_for('produits_list') }}" class="btn btn-primary">‚Ü©Ô∏è Retour</a>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
        <!-- Informations g√©n√©rales -->
        <div class="card" style="margin: 0;">
            <h3>üìã Informations g√©n√©rales</h3>
            <table style="width: 100%;">
                <tr>
                    <td><strong>Nom de l'article :</strong></td>
                    <td>{{ produit.nom }}</td>
                </tr>
                <tr>
                    <td><strong>Code / R√©f√©rence :</strong></td>
                    <td>{{ produit.code or '-' }}</td>
                </tr>
                <tr>
                    <td><strong>Unit√© de mesure :</strong></td>
                    <td>
                        {{ produit.unite_mesure.nom }}
                        {% if produit.unite_mesure.symbole %}
                            ({{ produit.unite_mesure.symbole }})
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td><strong>Cat√©gorie :</strong></td>
                    <td>
                        <span class="badge badge-info">{{ produit.categorie.nom }}</span>
                        {% if produit.categorie.description %}
                            <small>{{ produit.categorie.description }}</small>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td><strong>Article stockable :</strong></td>
                    <td>
                        {% if produit.article_stockable == 'OUI' %}
                            <span class="badge badge-success">‚úì Oui</span>
                        {% else %}
                            <span class="badge badge-danger">‚úó Non</span>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- Informations de stock -->
        <div class="card" style="margin: 0;">
            <h3>üìä Gestion de stock</h3>
            <table style="width: 100%;">
                <tr>
                    <td><strong>Quantit√© initiale :</strong></td>
                    <td>
                        {% if produit.article_stockable == 'OUI' %}
                            {{ "%.2f"|format(produit.quantite_initiale) }}
                            {% if produit.unite_mesure and produit.unite_mesure.symbole %}
                                {{ produit.unite_mesure.symbole }}
                            {% endif %}
                        {% else %}
                            <span class="badge badge-secondary">Non stockable</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td><strong>Stock actuel :</strong></td>
                    <td>
                        {% if produit.article_stockable == 'OUI' %}
                            {% set stock_actuel = produit.stock_actuel if produit.stock_actuel is not none else 0 %}
                            <span class="stock-value {% if stock_actuel <= 0 %}stock-rupture{% elif stock_actuel <= produit.stock_minimum %}stock-bas{% else %}stock-normal{% endif %}">
                                {{ "%.2f"|format(stock_actuel) }}
                                {% if produit.unite_mesure and produit.unite_mesure.symbole %}
                                    {{ produit.unite_mesure.symbole }}
                                {% endif %}
                            </span>
                        {% else %}
                            <span class="badge badge-secondary">N/A</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td><strong>Stock minimum :</strong></td>
                    <td>
                        {% if produit.article_stockable == 'OUI' and produit.stock_minimum %}
                            {{ "%.2f"|format(produit.stock_minimum) }}
                            {% if produit.unite_mesure and produit.unite_mesure.symbole %}
                                {{ produit.unite_mesure.symbole }}
                            {% endif %}
                        {% else %}
                            <span class="badge badge-secondary">-</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td><strong>√âtat du stock :</strong></td>
                    <td>
                        {% if produit.article_stockable == 'OUI' %}
                            {% set stock_actuel = produit.stock_actuel if produit.stock_actuel is not none else 0 %}
                            {% set stock_minimum = produit.stock_minimum if produit.stock_minimum is not none else 0 %}
                            
                            {% if stock_actuel <= 0 %}
                                <span class="badge badge-danger">‚ö†Ô∏è Rupture de stock</span>
                            {% elif stock_actuel <= stock_minimum %}
                                <span class="badge badge-warning">‚ö†Ô∏è Stock bas (en dessous du minimum)</span>
                            {% else %}
                                <span class="badge badge-success">‚úì Stock normal</span>
                            {% endif %}
                        {% else %}
                            <span class="badge badge-secondary">Non applicable</span>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- Prix et taxes -->
        <div class="card" style="margin: 0;">
            <h3>üí∞ Prix et taxes</h3>
            <table style="width: 100%;">
                <tr>
                    <td><strong>TVA :</strong></td>
                    <td>{{ produit.tva }}%</td>
                </tr>
                <tr>
                    <td><strong>TC :</strong></td>
                    <td>
                        {% if produit.tc == 'OUI' %}
                            <span class="badge badge-success">OUI</span>
                        {% else %}
                            <span class="badge badge-danger">NON</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td><strong>PF :</strong></td>
                    <td>
                        {% if produit.pf == 'OUI' %}
                            <span class="badge badge-success">OUI</span>
                        {% else %}
                            <span class="badge badge-danger">NON</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td><strong>Prix de vente TTC :</strong></td>
                    <td><strong class="prix-vente">{{ "{:,.0f}".format(produit.pv_ttc).replace(',', ' ') }} FBU</strong></td>
                </tr>
                <tr>
                    <td><strong>PRU (Prix de revient) :</strong></td>
                    <td>
                        {% if produit.article_stockable == 'OUI' and produit.pru %}
                            <strong>{{ "{:,.0f}".format(produit.pru).replace(',', ' ') }} FBU</strong>
                        {% else %}
                            <span class="badge badge-secondary">-</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td><strong>Marge unitaire :</strong></td>
                    <td>
                        {% if produit.article_stockable == 'OUI' and produit.pru and produit.pv_ttc %}
                            {% set marge = produit.pv_ttc - produit.pru %}
                            {% set taux_marge = (marge / produit.pru * 100) if produit.pru > 0 else 0 %}
                            <strong class="{% if marge > 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ "{:,.0f}".format(marge).replace(',', ' ') }} FBU 
                                ({{ "%.1f"|format(taux_marge) }}%)
                            </strong>
                        {% else %}
                            <span class="badge badge-secondary">-</span>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- Valeur du stock -->
        <div class="card" style="margin: 0;">
            <h3>üíµ Valeur du stock</h3>
            <table style="width: 100%;">
                <tr>
                    <td><strong>Valeur au PRU :</strong></td>
                    <td>
                        {% if produit.article_stockable == 'OUI' and produit.stock_actuel and produit.pru %}
                            {% set valeur_stock_pru = produit.stock_actuel * produit.pru %}
                            <strong>{{ "{:,.0f}".format(valeur_stock_pru).replace(',', ' ') }} FBU</strong>
                        {% else %}
                            <span class="badge badge-secondary">-</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td><strong>Valeur au prix de vente :</strong></td>
                    <td>
                        {% if produit.article_stockable == 'OUI' and produit.stock_actuel %}
                            {% set valeur_stock_vente = produit.stock_actuel * produit.pv_ttc %}
                            <strong>{{ "{:,.0f}".format(valeur_stock_vente).replace(',', ' ') }} FBU</strong>
                        {% else %}
                            <span class="badge badge-secondary">-</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td><strong>B√©n√©fice potentiel :</strong></td>
                    <td>
                        {% if produit.article_stockable == 'OUI' and produit.stock_actuel and produit.pru and produit.pv_ttc %}
                            {% set benefice = produit.stock_actuel * (produit.pv_ttc - produit.pru) %}
                            <strong class="text-success">{{ "{:,.0f}".format(benefice).replace(',', ' ') }} FBU</strong>
                        {% else %}
                            <span class="badge badge-secondary">-</span>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    </div>
    
    <!-- M√©tadonn√©es -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
        <div class="card" style="margin: 0;">
            <h3>üìÖ Dates</h3>
            <table style="width: 100%;">
                <tr>
                    <td><strong>Date de cr√©ation :</strong></td>
                    <td>{{ produit.date_creation.strftime('%d/%m/%Y %H:%M') if produit.date_creation else '-' }}</td>
                </tr>
            </table>
        </div>
        
        <div class="card" style="margin: 0;">
            <h3>üî¢ Identifiants</h3>
            <table style="width: 100%;">
                <tr>
                    <td><strong>ID Produit :</strong></td>
                    <td>{{ produit.id }}</td>
                </tr>
                <tr>
                    <td><strong>Code :</strong></td>
                    <td>{{ produit.code or '-' }}</td>
                </tr>
            </table>
        </div>
    </div>
    
    <!-- Derniers mouvements de stock -->
    <!-- Derniers mouvements de stock -->
{% if produit.article_stockable == 'OUI' and produit.mouvements_stock %}
<div class="card" style="margin-top: 20px;">
    <h3>üìã Derniers mouvements de stock</h3>
    <table style="width: 100%;">
        <thead>
            <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Quantit√©</th>
                <th>Stock apr√®s</th>
                <th>Commentaire</th>
            </tr>
        </thead>
        <tbody>
            {# First sort the mouvements by date (newest first), then take only the first 5 #}
            {% for mouvement in produit.mouvements_stock|sort(attribute='date_mouvement', reverse=true) %}
                {% if loop.index <= 5 %}
                <tr>
                    <td>{{ mouvement.date_mouvement.strftime('%d/%m/%Y %H:%M') if mouvement.date_mouvement else '-' }}</td>
                    <td>
                        {% if mouvement.type_mouvement == 'entree' %}
                            <span class="badge badge-success">Entr√©e</span>
                        {% elif mouvement.type_mouvement == 'sortie' %}
                            <span class="badge badge-danger">Sortie</span>
                        {% else %}
                            <span class="badge badge-info">{{ mouvement.type_mouvement }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if mouvement.type_mouvement == 'entree' %}
                            +{{ "%.2f"|format(mouvement.quantite) }}
                        {% else %}
                            -{{ "%.2f"|format(mouvement.quantite) }}
                        {% endif %}
                        {% if produit.unite_mesure and produit.unite_mesure.symbole %}
                            {{ produit.unite_mesure.symbole }}
                        {% endif %}
                    </td>
                    <td>
                        {{ "%.2f"|format(mouvement.stock_apres) if mouvement.stock_apres is not none else '-' }}
                        {% if produit.unite_mesure and produit.unite_mesure.symbole %}
                            {{ produit.unite_mesure.symbole }}
                        {% endif %}
                    </td>
                    <td>{{ mouvement.commentaire or '-' }}</td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% if produit.mouvements_stock|length > 5 %}
    <div style="text-align: right; margin-top: 10px;">
        <a href="{{ url_for('produit_mouvements', id=produit.id) }}" class="btn btn-info btn-sm">Voir tous les mouvements</a>
    </div>
    {% endif %}
</div>
{% endif %}
    
    <!-- Statistiques de vente -->
    <div class="card" style="margin-top: 20px;">
        <h3>üìä Statistiques de vente</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
            <div class="stat-box">
                <h4>Total factur√©</h4>
                <p class="stat-value">
                    {% if produit.lignes_facture %}
                        {% set total = 0 %}
                        {% for ligne in produit.lignes_facture %}
                            {% set total = total + (ligne.quantite * ligne.prix_unitaire) %}
                        {% endfor %}
                        {{ "{:,.0f}".format(total).replace(',', ' ') }} FBU
                    {% else %}
                        0 FBU
                    {% endif %}
                </p>
            </div>
            <div class="stat-box">
                <h4>Quantit√© vendue</h4>
                <p class="stat-value" style="color: #48bb78;">
                    {% if produit.lignes_facture %}
                        {% set quantite = 0 %}
                        {% for ligne in produit.lignes_facture %}
                            {% set quantite = quantite + ligne.quantite %}
                        {% endfor %}
                        {{ "%.2f"|format(quantite) }}
                        {% if produit.unite_mesure and produit.unite_mesure.symbole %}
                            {{ produit.unite_mesure.symbole }}
                        {% endif %}
                    {% else %}
                        0
                    {% endif %}
                </p>
            </div>
            <div class="stat-box">
                <h4>Nombre de factures</h4>
                <p class="stat-value" style="color: #ed8936;">{{ produit.lignes_facture|length if produit.lignes_facture else 0 }}</p>
            </div>
        </div>
    </div>
</div>

<style>
    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    .badge-success {
        background: #d4edda;
        color: #155724;
    }
    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }
    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }
    .badge-info {
        background: #d1ecf1;
        color: #0c5460;
    }
    .badge-secondary {
        background: #e2e8f0;
        color: #4a5568;
    }
    
    .stock-normal {
        color: #28a745;
        font-weight: bold;
    }
    .stock-bas {
        color: #ffc107;
        font-weight: bold;
    }
    .stock-rupture {
        color: #dc3545;
        font-weight: bold;
    }
    
    .prix-vente {
        font-size: 1.2rem;
        color: #667eea;
    }
    
    .text-success {
        color: #28a745;
    }
    .text-danger {
        color: #dc3545;
    }
    
    .stat-box {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: transform 0.2s;
    }
    .stat-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 10px 0 0 0;
    }
    
    table td {
        padding: 8px 0;
    }
    table td:first-child {
        font-weight: 600;
        color: #4a5568;
        width: 40%;
    }
</style>
{% endblock %}