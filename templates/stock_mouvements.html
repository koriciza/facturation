<!-- templates/stock_mouvements.html - Updated version -->
{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="card">
        <div class="card-header">
            <h2>üìä Historique des mouvements - {{ produit.nom }}</h2>
            <div>
                <a href="{{ url_for('stock_ajuster', produit_id=produit.id) }}" class="btn btn-warning">‚öñÔ∏è Ajuster le stock</a>
                <a href="{{ url_for('stock_list') }}" class="btn btn-primary">‚Ü©Ô∏è Retour au stock</a>
            </div>
        </div>
        
        <div class="card-body">
            {% set stock_actuel = produit.stock_actuel if produit.stock_actuel is not none else 0 %}
            {% set stock_minimum = produit.stock_minimum if produit.stock_minimum is not none else 0 %}
            
            <!-- Current Stock Summary -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h3>Stock actuel</h3>
                   
                {% set stock_status = 'danger' if stock_actuel <= 0 else 'warning' if stock_actuel <= stock_minimum else 'normal' %}

                <p class="stock-display" data-stock="{{ stock_status }}">
                    {{ stock_actuel }}
                    {% if produit.unite_mesure and produit.unite_mesure.symbole %}
                        {{ produit.unite_mesure.symbole }}
                    {% endif %}
                </p>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h3>Stock minimum</h3>
                    <p style="font-size: 1.5rem;">{{ stock_minimum }}</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h3>Total mouvements</h3>
                    <p style="font-size: 1.5rem;">{{ mouvements|length }}</p>
                </div>
            </div>
            
            <!-- Movements Table -->
            <h3>Historique des mouvements</h3>
            
            {% if mouvements %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Quantit√©</th>
                            <th>Stock avant</th>
                            <th>Stock apr√®s</th>
                            <th>Commentaire</th>
                            <th>Utilisateur</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mouvement in mouvements %}
                        <tr>
                            <td>{{ mouvement.date_mouvement.strftime('%d/%m/%Y %H:%M') if mouvement.date_mouvement else '-' }}</td>
                            <td>
                                {% if mouvement.type_mouvement == 'entree' %}
                                    <span class="badge badge-success">Entr√©e</span>
                                {% elif mouvement.type_mouvement == 'sortie' %}
                                    <span class="badge badge-danger">Sortie</span>
                                {% else %}
                                    <span class="badge badge-warning">Ajustement</span>
                                {% endif %}
                            </td>
                            <td>
                                {% set quantite = mouvement.quantite if mouvement.quantite is not none else 0 %}
                                {% if quantite > 0 %}
                                    <span style="color: #28a745;">+{{ quantite }}</span>
                                {% else %}
                                    <span style="color: #dc3545;">{{ quantite }}</span>
                                {% endif %}
                            </td>
                            <td>{{ mouvement.stock_avant if mouvement.stock_avant is not none else 0 }}</td>
                            <td>{{ mouvement.stock_apres if mouvement.stock_apres is not none else 0 }}</td>
                            <td>{{ mouvement.commentaire or '-' }}</td>
                            <td>{{ mouvement.utilisateur or 'Syst√®me' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 5px;">
                <p style="color: #6c757d; font-size: 1.2rem;">Aucun mouvement enregistr√© pour ce produit</p>
                <a href="{{ url_for('stock_ajuster', produit_id=produit.id) }}" class="btn btn-warning">‚öñÔ∏è Effectuer un premier ajustement</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    .badge-success {
        background: #d4edda;
        color: #155724;
    }
    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }
    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }
    .table-container {
        overflow-x: auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th {
        background: #343a40;
        color: white;
        padding: 12px;
        text-align: left;
    }
    td {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    tr:hover {
        background: #f8f9fa;
    }

.stock-display {
    font-size: 2rem;
    font-weight: bold;
}
.stock-display[data-stock="danger"] { color: #dc3545; }
.stock-display[data-stock="warning"] { color: #ffc107; }
.stock-display[data-stock="normal"] { color: #28a745; }
</style>

{% endblock %}